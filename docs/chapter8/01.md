# 第一节 集合体组合与合并 {#chapter8-part1}

我们将在本节介绍 Three.js 的两个基本功能：将对象组合在一起，以及将多个网格合并为一个网格。我们先从对象组合开始。

## 对象组合 {#chapter8-part1-1}

在前面某些章节里使用多种材质时，你已经见过对象组合。当从一个几何体创建网格并且使用多种材质时，Three.js 就会创建一个组。该几何体的多份副本会添加到这个组里，每份副本都有自己特定的材质。而这个组就是我们得到的结果，看上去就像是一个网格拥有多种材质。但是实际上它是一个包含多个网格的组。

创建组非常简单。每个你创建的网格都可以包含子元素，子元素可以使用 `add` 函数来添加。在组中添加子元素的效果是：你可以移动、缩放、旋转和变形父对象，而所有的子对象都将会受到影响。让我们来看一个例子（ [ `01-grouping.html` ](/example/chapter8/01-grouping) ），如图 8.1 所示。

<Image :index="1" />

这个例子里，你可以使用控制菜单来移动球体和方块。如果选中了 rotate 选项，你会看到这两个网格绕着它们的中心旋转。这不是什么新东西，也并不令人激动。但是，这两个对象并不是被直接添加到场景中的，而是添加到一个组中。代码如下所示：

```js
sphere = createMesh(new THREE.SphereGeometry(5, 10, 10));
cube = createMesh(new THREE.BoxGeometry(6, 6, 6));

group = new THREE.Group();
group.add(sphere);
group.add(cube);

scene.add(group);
```

在上面的代码中，我们创建了一个 `THREE.Group` （组）类的对象。该类与 `THREE.Mesh` 和 `THREE.Scene` 类共同的基类 `THREE.Object3D` 非常接近，唯一的不同是它本身并不含有任何可渲染的数据。

在这个例子中我们通过组对象的 `add` 函数将 `sphere` 和 `cube` 对象添加到组中，然后再将组对象整体添加到场景对象 `scene` 中。被添加到组对象中的三维物体，其本身仍然可以被单独移动、缩放和旋转。此外还可以对整个组对象进行相同的操作。看一下组菜单，你会发现 position（位置）和 scale（缩放）选项，可以使用这些选项来缩放和移动整个组。

这里要注意的一点是，当三维物体被添加到组对象中后，它们自身的位置、缩放和旋转参数便都是相对于组对象的对应参数的（译注：例如某组对象的位置参数为(10，0，0)，组内某物体的位置参数为(5，0，0)，当该组对象被直接添加到场景中时，该组内物体在场景中的位置为(15，0，0)。缩放和旋转参数与位置参数类似。）。

缩放和移动都很直观。但是要记住的是：当你旋转一个组时，并不是分别旋转组中的每一个对象，而是绕其中心旋转整个组（在我们的例子里，是绕着 `group` 对象的中心旋转整个组）。在这个例子里，我们在组的中心使用 `THREE.ArrowHelper` 对象放置了一个箭头，用来指示旋转点：

```js
var arrow = new THREE.ArrowHelper(
  new THREE.Vector3(0, 1, 0),
  group.position,
  10,
  0x0000ff
);
scene.add(arrow);
```

如果你选中了 `grouping` 和 `rotate` 选项，那么这个组就会开始旋转。你将会看到球体和方块一起绕着组的中心（箭头所指）旋转，如图 8.2 所示。

<Image :index="2" />

使用组的时候，你依然可以引用、修改和定位每一个单独的几何体。唯一需要记住的是：所有的定位、旋转和变形都是相对父对象的。下一节我们将看一下合并，可以将多个几何体组合并最终生成一个 `THREE.Geometry` 对象。

## 将多个网格合并成一个网格 {#chapter8-part1-2}

多数情况下使用组可以很容易地操纵和管理大量网格。但是当对象的数量非常多时，性能就会成为一个瓶颈。使用组，每个对象还是独立的，仍然需要对它们分别进行处理和渲染。通过 `THREE.Geometry.merge()` 函数，你可以将多个几何体合并起来创建一个联合体。在下面的例子里，你将会看到如何使用该函数，以及它对性能的影响。打开示例 [ `02-merging.html` ](/example/chapter8/02-merging) ，你会看到一个随机分布着很多半透明方块的场景。通过菜单中的滑块，你可以设置场景中的方块数量，点击 redraw 按钮可以重新绘制场景。根据你所使用的硬件，当方块的数量达到一定量时，性能就会开始下降。你可以从图 8.3 中看到，在我的环境中，性能在 6000 个对象左右时开始下降，刷新速度从通常的 60fps 下降到 40fps。

<Image :index="3" />

正如你所看到的，场景中能够添加的网格数量有一个上限。一般来讲你并不需要那么多网格，但是在创建某些游戏（例如 Minecraft）或者高级显示效果时，你可能需要管理大量的独立网格。
而使用 `THREE.Geometry.merge()` 则可以帮你解决这个问题。在看代码之前，我们先来运行一下这个示例，但是这次要选中 combine 复选框。当选中该选项时，我们将所有的方块合并成一个 `THREE.Geometry` ，然后将它添加到场景中，如图 8.4 所示。

<Image :index="4" />

正如你所看到的，我们可以轻松渲染 20000 个方块，而且没有任何性能损失。为达到该效果，我们要使用如下代码：

```js
var geometry = new THREE.Geometry();
for (var i = 0; i < controls.numberOfObjects; i++) {
  var cubeMesh = addcube();
  cubeMesh.updateMatrix();
  geometry.merge(cubeMesh.geometry, cubeMesh.matrix);
}
scene.add(new THREE.Mesh(geometry, cubeMaterial));
```

在这段代码里， `addCube()` 函数返回的是一个 `THREE.Mesh` 对象。在旧版本的 Three.js 中，我们可以使用 `THREE.GeometryUtils.merge` 函数将 `THREE.Mesh` 对象合并到 `THREE.Geometry` 对象中。在最新版本中，此功能已被弃用，而改为支持 `THREE.Geometry.merge` 函数。为了确保能正确定位和旋转合并的 `THREE.Geometry` 对象，我们不仅向 merge 函数提供 `THREE.Geometry` 对象，还提供该对象的变换矩阵。当我们将此矩阵添加到 merge 函数后，那么合并的方块将会被正确定位。

如此做 20000 次，我们得到的将是一个几何体，然后将它添加到场景中。如果看过代码，你会发现这个方法有几个缺陷。由于我们得到的是一个几何体，所以你不能为每个几何体单独添加材质。但是，这个问题在某种程度上可以用 `THREE.MeshFaceMaterial` 对象来解决。最大的缺陷是失去了对每个对象的单独控制。想要移动、旋转或缩放某个方块是不可能的（除非你能探索到相应的面和顶点，并分别对它们进行操作）。

通过组合和合并，你可以使用 Three.js 提供的基本几何体来创建大型的、复杂的几何体。如果你想创建更加高级的几何体，那么使用 Three.js 所提供的编程方式就不是最好、最简单的方法。幸运的是，Three.js 提供了其他创建几何体的方法。下一节，我们将会学习如何从外部资源中创建、加载几何体和网格。
